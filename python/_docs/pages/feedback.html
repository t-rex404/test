<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback CSV 一覧</title>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background: #f2f2f2; text-align: left; }
        caption { text-align: left; margin: 8px 0; font-weight: bold; }
        .badges { display: flex; gap: 12px; align-items: center; margin: 8px 0 16px; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 12px; color: #fff; }
        .badge-done { background: #28a745; }
        .badge-doing { background: #17a2b8; }
        .badge-todo { background: #6c757d; }
        .filter-btn { margin-left: 8px; padding: 4px 10px; }
        .muted { color: #6c757d; }
        .btn { padding: 2px 8px; margin-right: 6px; }
    </style>
    <script defer src="../js/script.js"></script>
</head>
<body>
<main class="container">
    <h1>Feedback CSV 一覧</h1>
    <p>更新日時: 2025-10-28 22:42:13</p>
    <section class="badges">
        <span>合計: <strong>0</strong></span>
        <span class="badge badge-done">完了: 0</span>
        <span class="badge badge-doing">対応中: 0</span>
        <span class="badge badge-todo">未対応: 0</span>
        <button id="togglePending" class="filter-btn" aria-pressed="false">未完了のみ表示</button>
        <span class="muted">ステータス列が無い場合は全て未対応として表示</span>
    </section>
    <section class="section">
        <table aria-label="統合CSV">
            <caption>統合ファイル: feedback_merged.csv</caption>
            <thead>
                <tr><th>status</th><th>操作</th></tr>
            </thead>
            <tbody>
<tr><td>データがありません</td></tr>
            </tbody>
        </table>
    </section>
    <p><a href="../index.html">← 一覧へ戻る</a></p>
</main>
<script>
// シンプルな未完了フィルタ
(function() {
  var btn = document.getElementById('togglePending');
  if (!btn) return;
  var pendingOnly = false;
  btn.addEventListener('click', function(){
    pendingOnly = !pendingOnly;
    btn.setAttribute('aria-pressed', String(pendingOnly));
    btn.textContent = pendingOnly ? '全件表示' : '未完了のみ表示';
    var rows = document.querySelectorAll('tbody tr');
    rows.forEach(function(tr){
      var st = tr.getAttribute('data-status') || 'todo';
      if (pendingOnly) {
        tr.style.display = (st === 'todo' || st === 'doing') ? '' : 'none';
      } else {
        tr.style.display = '';
      }
    });
  });
})();

// ステータス更新（ローカルAPIにPOST）
(function() {
  function updateBadge(tr, status){
    if (!tr) return;
    tr.setAttribute('data-status', status);
    var badge = tr.querySelector('.badge');
    if (!badge) return;
    if (status === 'done') { badge.textContent = '完了'; badge.className = 'badge badge-done'; }
    else if (status === 'doing') { badge.textContent = '対応中'; badge.className = 'badge badge-doing'; }
    else { badge.textContent = '未対応'; badge.className = 'badge badge-todo'; }
  }
  document.addEventListener('click', function(e){
    var t = e.target;
    if (!t.classList.contains('set-st')) return;
    var key = t.getAttribute('data-key');
    var status = t.getAttribute('data-status');
    if (!key || !status) return;
    fetch('http://127.0.0.1:8765/update-status', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ key: key, status: status })
    }).then(function(r){ return r.json(); }).then(function(json){
      if (json && json.ok) {
        var tr = t.closest('tr');
        updateBadge(tr, status);
      } else {
        alert('更新に失敗しました');
      }
    }).catch(function(){
      alert('ローカルサーバーに接続できません。run.cmd で起動中か確認してください。');
    });
  });
})();
</script>
</body>
</html>
