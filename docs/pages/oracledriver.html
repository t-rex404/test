<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OracleDriver.ps1 - 使用方法</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <h1>OracleDriver.ps1</h1>
            <p>ORACLEデータベース操作クラス</p>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <a href="../index.html" class="back-link">← メインページに戻る</a>

            <!-- 隠しコマンド用の透明な要素 -->
            <div id="hiddenCommand" style="position: fixed; top: 0; left: 0; width: 50px; height: 50px; z-index: 9999; opacity: 0; cursor: default;"></div>

            <!-- 概要 -->
            <div class="detail-page">
                <h2>概要</h2>
                <p>OracleDriverクラスは、ORACLEデータベースに対する操作を提供するPowerShellクラスです。DML、DDL、DCL、TCLの各操作を分けてメソッドを実装し、安全で効率的なデータベース操作を可能にします。</p>
                
                <div class="info-box">
                    <h3>主な機能</h3>
                    <ul>
                        <li><strong>DML操作</strong>: SELECT、INSERT、UPDATE、DELETE、MERGE</li>
                        <li><strong>DDL操作</strong>: CREATE TABLE、ALTER TABLE、DROP TABLE、CREATE INDEX、CREATE VIEW、CREATE SEQUENCE</li>
                        <li><strong>DCL操作</strong>: GRANT、REVOKE</li>
                        <li><strong>TCL操作</strong>: トランザクション制御、SAVEPOINT</li>
                        <li><strong>ユーティリティ</strong>: テーブル一覧取得、テーブル構造取得</li>
                    </ul>
                </div>
            </div>

            <!-- インストール・セットアップ -->
            <div class="detail-page">
                <h2>インストール・セットアップ</h2>
                
                <div class="method-category">
                    <h4>必要な依存関係</h4>
                    <ul class="method-list">
                        <li>Oracle Client（Oracle.ManagedDataAccess.Client）</li>
                        <li>PowerShell 5.1以上</li>
                        <li>ORACLEデータベースへの接続権限</li>
                    </ul>
                </div>

                <div class="code-block">
                    <pre># 共通ライブラリをインポート
. "$PSScriptRoot\_lib\Common.ps1"

# OracleDriverライブラリをインポート
. "$PSScriptRoot\_lib\OracleDriver.ps1"</pre>
                </div>

                <div class="warning-box">
                    <h3>注意事項</h3>
                    <ul>
                        <li>Oracle Clientがインストールされていることを確認してください</li>
                        <li>データベースへの接続権限があることを確認してください</li>
                        <li>使用後は必ずDisconnect()を呼び出してリソースを解放してください</li>
                    </ul>
                </div>
            </div>

            <!-- 基本的な使用方法 -->
            <div class="detail-page">
                <h2>基本的な使用方法</h2>
                
                <div class="method-category">
                    <h4>1. インスタンス作成と接続</h4>
                </div>

                <div class="code-block">
                    <pre># OracleDriverインスタンスを作成
$oracleDriver = [OracleDriver]::new()

# 接続パラメータを設定
$oracleDriver.SetConnectionParameters(
    "localhost",    # サーバー
    "1521",         # ポート
    "XE",           # サービス名
    "username",     # ユーザー名
    "password",     # パスワード
    "schema"        # スキーマ（オプション）
)

# データベースに接続
$oracleDriver.Connect()</pre>
                </div>

                <div class="method-category">
                    <h4>2. DML操作の例</h4>
                </div>

                <div class="code-block">
                    <pre># SELECT文の実行
$sql = "SELECT * FROM employees WHERE department_id = :dept_id"
$params = @{":dept_id" = 10}
$result = $oracleDriver.ExecuteSelect($sql, $params)

# INSERT文の実行
$insertSQL = @"
INSERT INTO employees (employee_id, first_name, last_name, email)
VALUES (:emp_id, :first_name, :last_name, :email)
"@
$insertParams = @{
    ":emp_id" = 1001
    ":first_name" = "John"
    ":last_name" = "Doe"
    ":email" = "john.doe@example.com"
}
$affectedRows = $oracleDriver.ExecuteInsert($insertSQL, $insertParams)

# UPDATE文の実行
$updateSQL = "UPDATE employees SET salary = :salary WHERE employee_id = :emp_id"
$updateParams = @{":salary" = 55000; ":emp_id" = 1001}
$affectedRows = $oracleDriver.ExecuteUpdate($updateSQL, $updateParams)

# DELETE文の実行
$deleteSQL = "DELETE FROM employees WHERE employee_id = :emp_id"
$deleteParams = @{":emp_id" = 1001}
$affectedRows = $oracleDriver.ExecuteDelete($deleteSQL, $deleteParams)</pre>
                </div>

                <div class="method-category">
                    <h4>3. DDL操作の例</h4>
                </div>

                <div class="code-block">
                    <pre># テーブルの作成
$createTableSQL = @"
CREATE TABLE test_table (
    id NUMBER(6) PRIMARY KEY,
    name VARCHAR2(50) NOT NULL,
    created_date DATE DEFAULT SYSDATE
)
"@
$oracleDriver.ExecuteCreateTable($createTableSQL)

# インデックスの作成
$createIndexSQL = "CREATE INDEX idx_test_name ON test_table(name)"
$oracleDriver.ExecuteCreateIndex($createIndexSQL)

# ビューの作成
$createViewSQL = "CREATE VIEW v_test AS SELECT id, name FROM test_table"
$oracleDriver.ExecuteCreateView($createViewSQL)

# シーケンスの作成
$createSequenceSQL = "CREATE SEQUENCE seq_test_id START WITH 1 INCREMENT BY 1"
$oracleDriver.ExecuteCreateSequence($createSequenceSQL)</pre>
                </div>

                <div class="method-category">
                    <h4>4. トランザクション制御の例</h4>
                </div>

                <div class="code-block">
                    <pre># トランザクションを開始
$oracleDriver.BeginTransaction()

try {
    # 複数の操作を実行
    $oracleDriver.ExecuteInsert($insertSQL, $insertParams)
    $oracleDriver.ExecuteUpdate($updateSQL, $updateParams)
    
    # SAVEPOINTを作成
    $oracleDriver.CreateSavepoint("checkpoint1")
    
    # 追加の操作
    $oracleDriver.ExecuteDelete($deleteSQL, $deleteParams)
    
    # トランザクションをコミット
    $oracleDriver.CommitTransaction()
}
catch {
    # エラーが発生した場合はロールバック
    $oracleDriver.RollbackTransaction()
    throw
}</pre>
                </div>
            </div>

            <!-- メソッド一覧 -->
            <div class="detail-page">
                <h2>メソッド一覧</h2>
                
                <div class="method-category">
                    <h4>初期化・接続関連</h4>
                    <ul class="method-list">
                        <li><strong>SetConnectionParameters(server, port, service_name, username, password, schema)</strong> - データベース接続パラメータを設定</li>
                        <li><strong>Connect()</strong> - ORACLEデータベースに接続</li>
                        <li><strong>Disconnect()</strong> - データベース接続を切断</li>
                    </ul>
                </div>

                <div class="method-category">
                    <h4>DML操作</h4>
                    <ul class="method-list">
                        <li><strong>ExecuteSelect(sql, parameters)</strong> - SELECT文を実行し、DataTableを返す</li>
                        <li><strong>ExecuteInsert(sql, parameters)</strong> - INSERT文を実行し、影響を受けた行数を返す</li>
                        <li><strong>ExecuteUpdate(sql, parameters)</strong> - UPDATE文を実行し、影響を受けた行数を返す</li>
                        <li><strong>ExecuteDelete(sql, parameters)</strong> - DELETE文を実行し、影響を受けた行数を返す</li>
                        <li><strong>ExecuteMerge(sql, parameters)</strong> - MERGE文を実行し、影響を受けた行数を返す</li>
                    </ul>
                </div>

                <div class="method-category">
                    <h4>DDL操作</h4>
                    <ul class="method-list">
                        <li><strong>ExecuteCreateTable(sql)</strong> - CREATE TABLE文を実行</li>
                        <li><strong>ExecuteAlterTable(sql)</strong> - ALTER TABLE文を実行</li>
                        <li><strong>ExecuteDropTable(tableName)</strong> - DROP TABLE文を実行</li>
                        <li><strong>ExecuteCreateIndex(sql)</strong> - CREATE INDEX文を実行</li>
                        <li><strong>ExecuteCreateView(sql)</strong> - CREATE VIEW文を実行</li>
                        <li><strong>ExecuteCreateSequence(sql)</strong> - CREATE SEQUENCE文を実行</li>
                    </ul>
                </div>

                <div class="method-category">
                    <h4>DCL操作</h4>
                    <ul class="method-list">
                        <li><strong>ExecuteGrant(sql)</strong> - GRANT文を実行</li>
                        <li><strong>ExecuteRevoke(sql)</strong> - REVOKE文を実行</li>
                    </ul>
                </div>

                <div class="method-category">
                    <h4>TCL操作</h4>
                    <ul class="method-list">
                        <li><strong>BeginTransaction()</strong> - トランザクションを開始</li>
                        <li><strong>CommitTransaction()</strong> - トランザクションをコミット</li>
                        <li><strong>RollbackTransaction()</strong> - トランザクションをロールバック</li>
                        <li><strong>CreateSavepoint(savepointName)</strong> - SAVEPOINTを作成</li>
                        <li><strong>RollbackToSavepoint(savepointName)</strong> - 指定したSAVEPOINTにロールバック</li>
                    </ul>
                </div>

                <div class="method-category">
                    <h4>ユーティリティメソッド</h4>
                    <ul class="method-list">
                        <li><strong>GetTableList(schema)</strong> - 指定したスキーマのテーブル一覧を取得</li>
                        <li><strong>GetTableStructure(tableName, schema)</strong> - 指定したテーブルの構造を取得</li>
                        <li><strong>IsConnected()</strong> - 接続状態を確認</li>
                        <li><strong>IsTransactionActive()</strong> - トランザクション状態を確認</li>
                        <li><strong>GetLastErrorMessage()</strong> - 最後のエラーメッセージを取得</li>
                    </ul>
                </div>
            </div>

            <!-- 使用例 -->
            <div class="detail-page">
                <h2>使用例</h2>
                
                <div class="method-category">
                    <h4>従業員データの一括処理</h4>
                </div>

                <div class="code-block">
                    <pre># 従業員データの一括挿入
$oracleDriver.BeginTransaction()

try {
    $employees = @(
        @{id = 1001; name = "John Doe"; email = "john@example.com"},
        @{id = 1002; name = "Jane Smith"; email = "jane@example.com"},
        @{id = 1003; name = "Bob Johnson"; email = "bob@example.com"}
    )
    
    $insertSQL = "INSERT INTO employees (id, name, email) VALUES (:id, :name, :email)"
    
    foreach ($emp in $employees) {
        $params = @{
            ":id" = $emp.id
            ":name" = $emp.name
            ":email" = $emp.email
        }
        $oracleDriver.ExecuteInsert($insertSQL, $params)
    }
    
    $oracleDriver.CommitTransaction()
    Write-Host "従業員データの一括挿入が完了しました。"
}
catch {
    $oracleDriver.RollbackTransaction()
    Write-Error "エラーが発生しました: $($_.Exception.Message)"
}</pre>
                </div>

                <div class="method-category">
                    <h4>データベース構造の確認</h4>
                </div>

                <div class="code-block">
                    <pre># テーブル一覧の取得
$tableList = $oracleDriver.GetTableList("HR")
Write-Host "テーブル数: $($tableList.Rows.Count)"

foreach ($table in $tableList.Rows) {
    Write-Host "テーブル: $($table['TABLE_NAME'])"
    
    # 各テーブルの構造を取得
    $structure = $oracleDriver.GetTableStructure($table['TABLE_NAME'], "HR")
    Write-Host "  カラム数: $($structure.Rows.Count)"
}</pre>
                </div>
            </div>

            <!-- エラーハンドリング -->
            <div class="detail-page">
                <h2>エラーハンドリング</h2>
                <p>OracleDriverクラスは、共通ライブラリのエラーハンドリング機能を利用して、詳細なエラー情報をログに記録します。</p>
                
                <div class="code-block">
                    <pre>try {
    $oracleDriver.Connect()
    $result = $oracleDriver.ExecuteSelect("SELECT * FROM non_existent_table")
}
catch {
    # エラーメッセージを取得
    $errorMessage = $oracleDriver.GetLastErrorMessage()
    Write-Host "エラーが発生しました: $errorMessage"
    
    # エラーログは自動的に記録されます
}</pre>
                </div>

                <div class="info-box">
                    <h3>エラーハンドリングの特徴</h3>
                    <ul>
                        <li><strong>統一されたエラー処理:</strong> 共通ライブラリのエラーハンドリング機能を使用</li>
                        <li><strong>詳細なログ出力:</strong> エラーの詳細情報を自動的にログに記録</li>
                        <li><strong>エラーメッセージ取得:</strong> GetLastErrorMessage()で最後のエラー情報を取得可能</li>
                    </ul>
                </div>
            </div>

            <!-- ベストプラクティス -->
            <div class="detail-page">
                <h2>ベストプラクティス</h2>
                
                <div class="info-box">
                    <h3>推奨される使用方法</h3>
                    <ul>
                        <li><strong>接続管理:</strong> 使用後は必ずDisconnect()を呼び出してリソースを解放してください。</li>
                        <li><strong>トランザクション制御:</strong> 複数の操作を行う場合は、適切にトランザクションを制御してください。</li>
                        <li><strong>パラメータ化クエリ:</strong> SQLインジェクション攻撃を防ぐため、パラメータ化クエリを使用してください。</li>
                        <li><strong>エラーハンドリング:</strong> try-catch文を使用して適切にエラーを処理してください。</li>
                        <li><strong>リソース管理:</strong> using文またはfinally句を使用してリソースを確実に解放してください。</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <script src="../js/script.js"></script>
</body>
</html> 